---
title: "Calorie Burning Report"
output: pdf_document
---

# Methods and procedure

## Data exploration
First let's load the data and look at the summary.
```{r}
requirements = c("nlme", "effects", "pastecs", "lattice", "psych", "ggplot2", "GGally", "mice", "VIM", "aod", "BaM", "lme4")
if (length(setdiff(requirements, rownames(installed.packages()))) > 0) {
  invisible(install.packages(setdiff(requirements, rownames(installed.packages())))) 
}
for (i in seq(1, length(requirements))) {
  invisible(library(requirements[i], character.only=T))
}
options(digits=4)
muscledata = read.table("muscle-incomplete.txt", header=T, na.strings = "NA")
summary(muscledata)
```

Here are some descriptive statistics.
```{r}
plot(muscledata)
```

Let's check correlation between the weight of an individual and the intensity of their workout, as defined by the calories burnt per hour, using the Pearson correlation coefficient:
```{r}
cor.test(muscledata$weight, muscledata$calhour, alternative="two.sided", method="pearson")
```

The P value is way, way more than 0.05. We accept the null hypothesis, there seems to be no significant correlation.

Let's try plotting a simple linear model to this relationship.
```{r}
weightCalhr = lm(weight~calhour, data=muscledata)
summary(weightCalhr)
```
The linear model confirms our suspicion that there is no relationship here.

Let's try another one:
```{r}
muscledata_edit = na.omit(muscledata)
muscledata.lm = lm(calories~weight+calhour+weight*calhour, data=muscledata_edit)
muscledata.lm.summary = summary(muscledata.lm)
muscledata.lm.summary
plot(allEffects(muscledata.lm))
```

```{r}
plot(allEffects(muscledata.lm))
```

There seems to be a relationship between calhour and missing data. Clearly, there is a Missing at Random (MAR) mechanism involved - P(Missing) depends only on the observed values of calhour.

```{r}
muscledata.lm.2 = lm(calories~calhour+weight+calhour*weight, data=muscledata_edit)
summary(muscledata.lm.2)
plot(allEffects(muscledata.lm.2))
```


## Missing data exploration

```{r}
aggr(muscledata, numbers = TRUE, prop = FALSE, ylab = c("Histogram of missing data", "Pattern"))
```


```{r}
aggr(muscledata, combined=TRUE, numbers = TRUE, prop = TRUE, cex.numbers=0.87, varheight = FALSE)
barMiss(muscledata[,c("calories","weight")])
histMiss(muscledata)
histMiss(muscledata, pos=2)
```



## Complete case analysis

## Multiple imputation analysis

```{r}
invisible(capture.output(muscledata.imp <- mice(muscledata, meth = c("", "", "norm"), m=100)))
invisible(muscledata.fit <- with(data=muscledata.imp, exp=glm(calories~weight+calhour+weight*calhour)))
MI.matrix<-matrix(0,100,4)
for(k in 1:100){ 
  invisible(MI.matrix[k,]<-coefficients(muscledata.fit$analyses[[k]]))
  }
MI.results=data.frame(Intercept=MI.matrix[,1], weight=MI.matrix[,2],calhour=MI.matrix[,3], interaction=MI.matrix[,4])
head(MI.results[1:10,])
muscledata.est <- pool(muscledata.fit)
summary(muscledata.est)
```

```{r}
values = complete(muscledata.imp, "long", inc=T)
muscledata.results.MIALL <- glm(calories~weight+calhour+weight*calhour, data=values)
plot(allEffects(muscledata.results.MIALL))
```

Clearly something cool happened here.

```{r}
col <- rep(c("pink","purple")[1+as.numeric(is.na(muscledata.imp$data$calories))],101)
stripplot(calories~.imp, data=values, jit=TRUE, fac=0.8, col=col, pch=20, cex=1.4, xlab="Imputation number")
```

## IPW analysis

```{r}
muscledata$r<-as.numeric(!is.na(muscledata$calories))
head(muscledata)
muscledata.ipw.glm<-glm(r ~ weight+calhour+weight*calhour, data=muscledata,family=binomial)
summary(muscledata.ipw.glm)
```

```{r}
muscledata$w<-1/fitted(muscledata.ipw.glm)
muscledata.results.ipw<- glm(calories~weight+calhour+weight*calhour, data=muscledata, weights=muscledata$w)
summary(muscledata.results.ipw)
plot(allEffects(muscledata.results.ipw))
```



# Discussion

And in my opnion, Bayesian would make sense. MI is better in here. You cannot give weights to lost data. 

# Conclusion

The missing data is correlated with the calhour - intensity of the exercise - hence there is something wrong with the experimental design. Such as the way they measured heat production, so they could not accurately measure calorie burning. While we have no data for low calhour values, attributing weights to the values we have is not workable for the 13 calhour data point. That being said, the MI approach provides a more robust estimates for missing data.

